{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import invariant from'invariant';import{CameraType,ImageType}from\"./CameraModule.types\";import*as Utils from\"./CameraUtils\";import*as CapabilityUtils from\"./CapabilityUtils\";import{FacingModeToCameraType,PictureSizes}from\"./constants\";import{isBackCameraAvailableAsync,isFrontCameraAvailableAsync}from\"./UserMediaManager\";export{ImageType,CameraType};var VALID_SETTINGS_KEYS=['autoFocus','flashMode','exposureCompensation','colorTemperature','iso','brightness','contrast','saturation','sharpness','focusDistance','whiteBalance','zoom'];var CameraModule=function(){function CameraModule(videoElement){var _this=this;_classCallCheck(this,CameraModule);this.videoElement=videoElement;this.onCameraReady=function(){};this.onMountError=function(){};this.stream=null;this.settings=null;this.isStartingCamera=false;this.cameraType=CameraType.front;this.webCameraSettings={autoFocus:'continuous',flashMode:'off',whiteBalance:'continuous',zoom:1};this.getAvailablePictureSizes=function _callee(ratio){return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",PictureSizes);case 1:case\"end\":return _context.stop();}}});};this.getAvailableCameraTypesAsync=function _callee2(){var devices,types;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(navigator.mediaDevices.enumerateDevices){_context2.next=2;break;}return _context2.abrupt(\"return\",[]);case 2:_context2.next=4;return _regeneratorRuntime.awrap(navigator.mediaDevices.enumerateDevices());case 4:devices=_context2.sent;_context2.t0=_regeneratorRuntime;_context2.t1=Promise;_context2.next=9;return _regeneratorRuntime.awrap(isFrontCameraAvailableAsync(devices));case 9:_context2.t2=_context2.sent;if(!_context2.t2){_context2.next=12;break;}_context2.t2=CameraType.front;case 12:_context2.t3=_context2.t2;_context2.next=15;return _regeneratorRuntime.awrap(isBackCameraAvailableAsync());case 15:_context2.t4=_context2.sent;if(!_context2.t4){_context2.next=18;break;}_context2.t4=CameraType.back;case 18:_context2.t5=_context2.t4;_context2.t6=[_context2.t3,_context2.t5];_context2.t7=_context2.t1.all.call(_context2.t1,_context2.t6);_context2.next=23;return _context2.t0.awrap.call(_context2.t0,_context2.t7);case 23:types=_context2.sent;return _context2.abrupt(\"return\",types.filter(Boolean));case 25:case\"end\":return _context2.stop();}}});};if(this.videoElement){this.videoElement.addEventListener('loadedmetadata',function(){_this.syncTrackCapabilities();});}}_createClass(CameraModule,[{key:\"updateWebCameraSettingsAsync\",value:function updateWebCameraSettingsAsync(nextSettings){var changes,_i,_Object$keys,key,nextValue,hasChanges;return _regeneratorRuntime.async(function updateWebCameraSettingsAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:changes={};_i=0,_Object$keys=Object.keys(nextSettings);case 2:if(!(_i<_Object$keys.length)){_context3.next=11;break;}key=_Object$keys[_i];if(VALID_SETTINGS_KEYS.includes(key)){_context3.next=6;break;}return _context3.abrupt(\"continue\",8);case 6:nextValue=nextSettings[key];if(nextValue!==this.webCameraSettings[key]){changes[key]=nextValue;}case 8:_i++;_context3.next=2;break;case 11:hasChanges=!!Object.keys(changes).length;this.webCameraSettings=_objectSpread({},this.webCameraSettings,{},changes);if(!hasChanges){_context3.next=16;break;}_context3.next=16;return _regeneratorRuntime.awrap(this.syncTrackCapabilities(changes));case 16:return _context3.abrupt(\"return\",hasChanges);case 17:case\"end\":return _context3.stop();}}},null,this);}},{key:\"setTypeAsync\",value:function setTypeAsync(value){return _regeneratorRuntime.async(function setTypeAsync$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!(value===this.cameraType)){_context4.next=2;break;}return _context4.abrupt(\"return\");case 2:this.cameraType=value;_context4.next=5;return _regeneratorRuntime.awrap(this.resumePreview());case 5:case\"end\":return _context4.stop();}}},null,this);}},{key:\"setPictureSize\",value:function setPictureSize(value){if(value===this.pictureSize){return;}invariant(PictureSizes.includes(value),\"expo-camera: CameraModule.setPictureSize(): invalid size supplied \"+value+\", expected one of: \"+PictureSizes.join(', '));this.pictureSize=value;}},{key:\"isTorchAvailable\",value:function isTorchAvailable(){return isCapabilityAvailable(this.videoElement,'torch');}},{key:\"isZoomAvailable\",value:function isZoomAvailable(){return isCapabilityAvailable(this.videoElement,'zoom');}},{key:\"onCapabilitiesReady\",value:function onCapabilitiesReady(track){var _this2=this;var settings,capabilities,constraints,clampedValues,_i2,_clampedValues,property,_validatedConstrainedValue,_args5=arguments;return _regeneratorRuntime.async(function onCapabilitiesReady$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:settings=_args5.length>1&&_args5[1]!==undefined?_args5[1]:{};capabilities=track.getCapabilities();constraints={};clampedValues=['exposureCompensation','colorTemperature','iso','brightness','contrast','saturation','sharpness','focusDistance','zoom'];for(_i2=0,_clampedValues=clampedValues;_i2<_clampedValues.length;_i2++){property=_clampedValues[_i2];if(capabilities[property]){constraints[property]=convertNormalizedSetting(capabilities[property],settings[property]);}}_validatedConstrainedValue=function _validatedConstrainedValue(key,propName,converter){return validatedConstrainedValue(key,propName,converter(settings[propName]),capabilities,settings,_this2.cameraType);};if(capabilities.focusMode&&settings.autoFocus!==undefined){constraints.focusMode=_validatedConstrainedValue('focusMode','autoFocus',CapabilityUtils.convertAutoFocusJSONToNative);}if(capabilities.torch&&settings.flashMode!==undefined){constraints.torch=_validatedConstrainedValue('torch','flashMode',CapabilityUtils.convertFlashModeJSONToNative);}if(capabilities.whiteBalanceMode&&settings.whiteBalance!==undefined){constraints.whiteBalanceMode=_validatedConstrainedValue('whiteBalanceMode','whiteBalance',CapabilityUtils.convertWhiteBalanceJSONToNative);}_context5.next=11;return _regeneratorRuntime.awrap(track.applyConstraints({advanced:[constraints]}));case 11:case\"end\":return _context5.stop();}}});}},{key:\"applyVideoConstraints\",value:function applyVideoConstraints(constraints){return _regeneratorRuntime.async(function applyVideoConstraints$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(!(!this.stream||!this.stream.getVideoTracks)){_context6.next=2;break;}return _context6.abrupt(\"return\",false);case 2:_context6.next=4;return _regeneratorRuntime.awrap(applyConstraints(this.stream.getVideoTracks(),constraints));case 4:return _context6.abrupt(\"return\",_context6.sent);case 5:case\"end\":return _context6.stop();}}},null,this);}},{key:\"applyAudioConstraints\",value:function applyAudioConstraints(constraints){return _regeneratorRuntime.async(function applyAudioConstraints$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!(!this.stream||!this.stream.getAudioTracks)){_context7.next=2;break;}return _context7.abrupt(\"return\",false);case 2:_context7.next=4;return _regeneratorRuntime.awrap(applyConstraints(this.stream.getAudioTracks(),constraints));case 4:return _context7.abrupt(\"return\",_context7.sent);case 5:case\"end\":return _context7.stop();}}},null,this);}},{key:\"syncTrackCapabilities\",value:function syncTrackCapabilities(){var _this3=this;var settings,_args8=arguments;return _regeneratorRuntime.async(function syncTrackCapabilities$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:settings=_args8.length>0&&_args8[0]!==undefined?_args8[0]:{};if(!(this.stream&&this.stream.getVideoTracks)){_context8.next=4;break;}_context8.next=4;return _regeneratorRuntime.awrap(Promise.all(this.stream.getVideoTracks().map(function(track){return _this3.onCapabilitiesReady(track,settings);})));case 4:case\"end\":return _context8.stop();}}},null,this);}},{key:\"setStream\",value:function setStream(stream){this.stream=stream;this.settings=stream?stream.getTracks()[0].getSettings():null;setVideoSource(this.videoElement,stream);}},{key:\"getActualCameraType\",value:function getActualCameraType(){if(this.settings){var _this$settings$facing=this.settings.facingMode,facingMode=_this$settings$facing===void 0?'user':_this$settings$facing;return FacingModeToCameraType[facingMode];}return null;}},{key:\"ensureCameraIsRunningAsync\",value:function ensureCameraIsRunningAsync(){return _regeneratorRuntime.async(function ensureCameraIsRunningAsync$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(this.stream){_context9.next=3;break;}_context9.next=3;return _regeneratorRuntime.awrap(this.resumePreview());case 3:case\"end\":return _context9.stop();}}},null,this);}},{key:\"resumePreview\",value:function resumePreview(){var stream;return _regeneratorRuntime.async(function resumePreview$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:if(!this.isStartingCamera){_context10.next=2;break;}return _context10.abrupt(\"return\",null);case 2:this.isStartingCamera=true;_context10.prev=3;this.stopAsync();_context10.next=7;return _regeneratorRuntime.awrap(Utils.getStreamDevice(this.type));case 7:stream=_context10.sent;this.setStream(stream);this.isStartingCamera=false;this.onCameraReady();return _context10.abrupt(\"return\",stream);case 14:_context10.prev=14;_context10.t0=_context10[\"catch\"](3);this.isStartingCamera=false;this.onMountError({nativeEvent:_context10.t0});case 18:return _context10.abrupt(\"return\",null);case 19:case\"end\":return _context10.stop();}}},null,this,[[3,14]]);}},{key:\"takePicture\",value:function takePicture(config){var base64=Utils.captureImage(this.videoElement,config);var capturedPicture={uri:base64,base64:base64,width:0,height:0};if(this.settings){var _this$settings=this.settings,_this$settings$width=_this$settings.width,width=_this$settings$width===void 0?0:_this$settings$width,_this$settings$height=_this$settings.height,height=_this$settings$height===void 0?0:_this$settings$height;capturedPicture.width=width;capturedPicture.height=height;capturedPicture.exif=this.settings;}if(config.onPictureSaved){config.onPictureSaved({nativeEvent:{data:capturedPicture,id:config.id}});}return capturedPicture;}},{key:\"stopAsync\",value:function stopAsync(){stopMediaStream(this.stream);this.setStream(null);}},{key:\"type\",get:function get(){return this.cameraType;}}]);return CameraModule;}();function stopMediaStream(stream){if(!stream)return;if(stream.getAudioTracks)stream.getAudioTracks().forEach(function(track){return track.stop();});if(stream.getVideoTracks)stream.getVideoTracks().forEach(function(track){return track.stop();});if(isMediaStreamTrack(stream))stream.stop();}function setVideoSource(video,stream){try{video.srcObject=stream;}catch(_){if(stream){video.src=window.URL.createObjectURL(stream);}else if(typeof video.src==='string'){window.URL.revokeObjectURL(video.src);}}}function applyConstraints(tracks,constraints){return _regeneratorRuntime.async(function applyConstraints$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.prev=0;_context12.next=3;return _regeneratorRuntime.awrap(Promise.all(tracks.map(function _callee3(track){return _regeneratorRuntime.async(function _callee3$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return _regeneratorRuntime.awrap(track.applyConstraints({advanced:[constraints]}));case 2:case\"end\":return _context11.stop();}}});})));case 3:return _context12.abrupt(\"return\",true);case 6:_context12.prev=6;_context12.t0=_context12[\"catch\"](0);return _context12.abrupt(\"return\",false);case 9:case\"end\":return _context12.stop();}}},null,null,[[0,6]]);}function isCapabilityAvailable(video,keyName){var stream=video.srcObject;if(stream instanceof MediaStream){var videoTrack=stream.getVideoTracks()[0];if(typeof videoTrack.getCapabilities==='undefined'){return false;}var _capabilities=videoTrack.getCapabilities();return!!_capabilities[keyName];}return false;}function isMediaStreamTrack(input){return typeof input.stop==='function';}function convertNormalizedSetting(range,value){if(!value)return;var converted=convertRange(value,[range.min,range.max]);return Math.min(range.max,Math.max(range.min,converted));}function convertRange(value,r2){var r1=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[0,1];return(value-r1[0])*(r2[1]-r2[0])/(r1[1]-r1[0])+r2[0];}function validatedConstrainedValue(constraintKey,settingsKey,convertedSetting,capabilities,settings,cameraType){var setting=settings[settingsKey];if(Array.isArray(capabilities[constraintKey])&&convertedSetting&&!capabilities[constraintKey].includes(convertedSetting)){console.warn(\" { \"+settingsKey+\": \\\"\"+setting+\"\\\" } (converted to \\\"\"+convertedSetting+\"\\\" in the browser) is not supported for camera type \\\"\"+cameraType+\"\\\" in your browser. Using the default value instead.\");return undefined;}return convertedSetting;}export default CameraModule;","map":{"version":3,"sources":["../../src/CameraModule/CameraModule.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-env browser */\nimport invariant from 'invariant';\n\nimport { PictureOptions } from '../Camera.types';\nimport { CameraType, CapturedPicture, CaptureOptions, ImageType } from './CameraModule.types';\nimport * as Utils from './CameraUtils';\nimport * as CapabilityUtils from './CapabilityUtils';\nimport { FacingModeToCameraType, PictureSizes } from './constants';\nimport { isBackCameraAvailableAsync, isFrontCameraAvailableAsync } from './UserMediaManager';\n\nexport { ImageType, CameraType, CaptureOptions };\n\ntype OnCameraReadyListener = () => void;\ntype OnMountErrorListener = (event: { nativeEvent: Error }) => void;\n\nexport type WebCameraSettings = Partial<{\n  autoFocus: string;\n  flashMode: string;\n  whiteBalance: string;\n  exposureCompensation: number;\n  colorTemperature: number;\n  iso: number;\n  brightness: number;\n  contrast: number;\n  saturation: number;\n  sharpness: number;\n  focusDistance: number;\n  zoom: number;\n}>;\n\nconst VALID_SETTINGS_KEYS = [\n  'autoFocus',\n  'flashMode',\n  'exposureCompensation',\n  'colorTemperature',\n  'iso',\n  'brightness',\n  'contrast',\n  'saturation',\n  'sharpness',\n  'focusDistance',\n  'whiteBalance',\n  'zoom',\n];\n\nclass CameraModule {\n  public onCameraReady: OnCameraReadyListener = () => {};\n  public onMountError: OnMountErrorListener = () => {};\n  private stream: MediaStream | null = null;\n  private settings: MediaTrackSettings | null = null;\n  private pictureSize?: string;\n  private isStartingCamera = false;\n  private cameraType: CameraType = CameraType.front;\n  private webCameraSettings: WebCameraSettings = {\n    autoFocus: 'continuous',\n    flashMode: 'off',\n    whiteBalance: 'continuous',\n    zoom: 1,\n  };\n\n  public get type(): CameraType {\n    return this.cameraType;\n  }\n\n  constructor(private videoElement: HTMLVideoElement) {\n    if (this.videoElement) {\n      this.videoElement.addEventListener('loadedmetadata', () => {\n        this.syncTrackCapabilities();\n      });\n    }\n  }\n\n  public async updateWebCameraSettingsAsync(nextSettings: {\n    [key: string]: any;\n  }): Promise<boolean> {\n    const changes: WebCameraSettings = {};\n\n    for (const key of Object.keys(nextSettings)) {\n      if (!VALID_SETTINGS_KEYS.includes(key)) continue;\n      const nextValue = nextSettings[key];\n      if (nextValue !== this.webCameraSettings[key]) {\n        changes[key] = nextValue;\n      }\n    }\n\n    // Only update the native camera if changes were found\n    const hasChanges = !!Object.keys(changes).length;\n\n    this.webCameraSettings = { ...this.webCameraSettings, ...changes };\n    if (hasChanges) {\n      await this.syncTrackCapabilities(changes);\n    }\n\n    return hasChanges;\n  }\n\n  public async setTypeAsync(value: CameraType) {\n    if (value === this.cameraType) {\n      return;\n    }\n    this.cameraType = value;\n\n    await this.resumePreview();\n  }\n\n  public setPictureSize(value: string) {\n    if (value === this.pictureSize) {\n      return;\n    }\n    invariant(\n      PictureSizes.includes(value),\n      `expo-camera: CameraModule.setPictureSize(): invalid size supplied ${value}, expected one of: ${PictureSizes.join(\n        ', '\n      )}`\n    );\n\n    // TODO: Bacon: IMP\n    // const [width, height] = value.split('x');\n    // const aspectRatio = parseFloat(width) / parseFloat(height);\n\n    this.pictureSize = value;\n  }\n\n  public isTorchAvailable(): boolean {\n    return isCapabilityAvailable(this.videoElement, 'torch');\n  }\n\n  public isZoomAvailable(): boolean {\n    return isCapabilityAvailable(this.videoElement, 'zoom');\n  }\n\n  // https://developer.mozilla.org/en-US/docs/Web/API/MediaTrackConstraints\n  private async onCapabilitiesReady(\n    track: MediaStreamTrack,\n    settings: WebCameraSettings = {}\n  ): Promise<void> {\n    const capabilities = track.getCapabilities();\n\n    // Create an empty object because if you set a constraint that isn't available an error will be thrown.\n    const constraints: MediaTrackConstraintSet = {};\n\n    // TODO: Bacon: Add `pointsOfInterest` support\n    const clampedValues = [\n      'exposureCompensation',\n      'colorTemperature',\n      'iso',\n      'brightness',\n      'contrast',\n      'saturation',\n      'sharpness',\n      'focusDistance',\n      'zoom',\n    ];\n\n    for (const property of clampedValues) {\n      if (capabilities[property]) {\n        constraints[property] = convertNormalizedSetting(\n          capabilities[property],\n          settings[property]\n        );\n      }\n    }\n\n    const _validatedConstrainedValue = (key, propName, converter) =>\n      validatedConstrainedValue(\n        key,\n        propName,\n        converter(settings[propName]),\n        capabilities,\n        settings,\n        this.cameraType\n      );\n\n    if (capabilities.focusMode && settings.autoFocus !== undefined) {\n      constraints.focusMode = _validatedConstrainedValue(\n        'focusMode',\n        'autoFocus',\n        CapabilityUtils.convertAutoFocusJSONToNative\n      );\n    }\n\n    if (capabilities.torch && settings.flashMode !== undefined) {\n      constraints.torch = _validatedConstrainedValue(\n        'torch',\n        'flashMode',\n        CapabilityUtils.convertFlashModeJSONToNative\n      );\n    }\n\n    if (capabilities.whiteBalanceMode && settings.whiteBalance !== undefined) {\n      constraints.whiteBalanceMode = _validatedConstrainedValue(\n        'whiteBalanceMode',\n        'whiteBalance',\n        CapabilityUtils.convertWhiteBalanceJSONToNative\n      );\n    }\n\n    await track.applyConstraints({ advanced: [constraints] as any });\n  }\n\n  private async applyVideoConstraints(constraints: { [key: string]: any }): Promise<boolean> {\n    if (!this.stream || !this.stream.getVideoTracks) {\n      return false;\n    }\n    return await applyConstraints(this.stream.getVideoTracks(), constraints);\n  }\n\n  private async applyAudioConstraints(constraints: { [key: string]: any }): Promise<boolean> {\n    if (!this.stream || !this.stream.getAudioTracks) {\n      return false;\n    }\n    return await applyConstraints(this.stream.getAudioTracks(), constraints);\n  }\n\n  private async syncTrackCapabilities(settings: WebCameraSettings = {}): Promise<void> {\n    if (this.stream && this.stream.getVideoTracks) {\n      await Promise.all(\n        this.stream.getVideoTracks().map(track => this.onCapabilitiesReady(track, settings))\n      );\n    }\n  }\n\n  private setStream(stream: MediaStream | null): void {\n    this.stream = stream;\n    this.settings = stream ? stream.getTracks()[0].getSettings() : null;\n    setVideoSource(this.videoElement, stream);\n  }\n\n  public getActualCameraType(): CameraType | null {\n    if (this.settings) {\n      // On desktop no value will be returned, in this case we should assume the cameraType is 'front'\n      const { facingMode = 'user' } = this.settings;\n      return FacingModeToCameraType[facingMode];\n    }\n    return null;\n  }\n\n  public async ensureCameraIsRunningAsync(): Promise<void> {\n    if (!this.stream) {\n      await this.resumePreview();\n    }\n  }\n\n  public async resumePreview(): Promise<MediaStream | null> {\n    if (this.isStartingCamera) {\n      return null;\n    }\n    this.isStartingCamera = true;\n    try {\n      this.stopAsync();\n      const stream = await Utils.getStreamDevice(this.type);\n      this.setStream(stream);\n      this.isStartingCamera = false;\n      this.onCameraReady();\n      return stream;\n    } catch (error) {\n      this.isStartingCamera = false;\n      this.onMountError({ nativeEvent: error });\n    }\n    return null;\n  }\n\n  public takePicture(config: PictureOptions): CapturedPicture {\n    const base64 = Utils.captureImage(this.videoElement, config);\n\n    const capturedPicture: CapturedPicture = {\n      uri: base64,\n      base64,\n      width: 0,\n      height: 0,\n    };\n\n    if (this.settings) {\n      const { width = 0, height = 0 } = this.settings;\n      capturedPicture.width = width;\n      capturedPicture.height = height;\n      // TODO: Bacon: verify/enforce exif shape.\n      capturedPicture.exif = this.settings;\n    }\n\n    if (config.onPictureSaved) {\n      config.onPictureSaved({ nativeEvent: { data: capturedPicture, id: config.id } });\n    }\n    return capturedPicture;\n  }\n\n  public stopAsync(): void {\n    stopMediaStream(this.stream);\n    this.setStream(null);\n  }\n\n  // TODO: Bacon: we don't even use ratio in native...\n  public getAvailablePictureSizes = async (ratio: string): Promise<string[]> => {\n    return PictureSizes;\n  };\n\n  public getAvailableCameraTypesAsync = async (): Promise<string[]> => {\n    if (!navigator.mediaDevices.enumerateDevices) {\n      return [];\n    }\n    const devices = await navigator.mediaDevices.enumerateDevices();\n\n    const types: (string | null)[] = await Promise.all([\n      (await isFrontCameraAvailableAsync(devices)) && CameraType.front,\n      (await isBackCameraAvailableAsync()) && CameraType.back,\n    ]);\n\n    return types.filter(Boolean) as string[];\n  };\n}\n\nfunction stopMediaStream(stream: MediaStream | null) {\n  if (!stream) return;\n  if (stream.getAudioTracks) stream.getAudioTracks().forEach(track => track.stop());\n  if (stream.getVideoTracks) stream.getVideoTracks().forEach(track => track.stop());\n  if (isMediaStreamTrack(stream)) stream.stop();\n}\n\nfunction setVideoSource(\n  video: HTMLVideoElement,\n  stream: MediaStream | MediaSource | Blob | null\n): void {\n  try {\n    video.srcObject = stream;\n  } catch (_) {\n    if (stream) {\n      video.src = window.URL.createObjectURL(stream);\n    } else if (typeof video.src === 'string') {\n      window.URL.revokeObjectURL(video.src);\n    }\n  }\n}\n\nasync function applyConstraints(\n  tracks: MediaStreamTrack[],\n  constraints: { [key: string]: any }\n): Promise<boolean> {\n  try {\n    await Promise.all(\n      tracks.map(async track => {\n        await track.applyConstraints({ advanced: [constraints] as any });\n      })\n    );\n    return true;\n  } catch (_) {\n    return false;\n  }\n}\n\nfunction isCapabilityAvailable(video: HTMLVideoElement, keyName: string): boolean {\n  const stream = video.srcObject;\n\n  if (stream instanceof MediaStream) {\n    const videoTrack = stream.getVideoTracks()[0];\n\n    if (typeof videoTrack.getCapabilities === 'undefined') {\n      return false;\n    }\n\n    const capabilities: any = videoTrack.getCapabilities();\n\n    return !!capabilities[keyName];\n  }\n\n  return false;\n}\n\nfunction isMediaStreamTrack(input: any): input is MediaStreamTrack {\n  return typeof input.stop === 'function';\n}\n\nfunction convertNormalizedSetting(range: MediaSettingsRange, value?: number): number | undefined {\n  if (!value) return;\n  // convert the normalized incoming setting to the native camera zoom range\n  const converted = convertRange(value, [range.min, range.max]);\n  // clamp value so we don't get an error\n  return Math.min(range.max, Math.max(range.min, converted));\n}\n\nfunction convertRange(value: number, r2: number[], r1: number[] = [0, 1]): number {\n  return ((value - r1[0]) * (r2[1] - r2[0])) / (r1[1] - r1[0]) + r2[0];\n}\n\nfunction validatedConstrainedValue(\n  constraintKey: string,\n  settingsKey: string,\n  convertedSetting: any,\n  capabilities: MediaTrackCapabilities,\n  settings: any,\n  cameraType: string\n): any {\n  const setting = settings[settingsKey];\n  if (\n    Array.isArray(capabilities[constraintKey]) &&\n    convertedSetting &&\n    !capabilities[constraintKey].includes(convertedSetting)\n  ) {\n    console.warn(\n      ` { ${settingsKey}: \"${setting}\" } (converted to \"${convertedSetting}\" in the browser) is not supported for camera type \"${cameraType}\" in your browser. Using the default value instead.`\n    );\n    return undefined;\n  }\n  return convertedSetting;\n}\n\nexport default CameraModule;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}